name: Salesforce CI-CD (Delta & Selective Deploy)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  validate-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ต้องใช้ 0 เพื่อให้ SGD คำนวณความต่างได้

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Salesforce CLI & SGD Plugin
        run: |
          npm install @salesforce/cli --global
          echo y | sf plugins install sfdx-git-delta

      - name: Authenticate to Salesforce
        env:
          SFDX_AUTH_URL: ${{ secrets.SFDX_AUTH_URL }}
        run: |
          echo "$SFDX_AUTH_URL" > sfdx_auth.txt
          sf org login sfdx-url --sfdx-url-file sfdx_auth.txt --set-default

      # --- 1. สร้าง Delta Package (เพิ่ม -p เพื่อกัน Error โฟลเดอร์ซ้ำ) ---
      - name: Create Delta Manifest
        run: |
          mkdir -p delta
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            sf sgd source delta --to HEAD --from origin/${{ github.base_ref }} --output delta/ --generate-delta
          else
            # รองรับกรณี Push ครั้งแรกที่ไม่มี HEAD~1
            FROM_SHA=$(git rev-parse HEAD~1 2>/dev/null || git rev-list --max-parents=0 HEAD)
            sf sgd source delta --to HEAD --from $FROM_SHA --output delta/ --generate-delta
          fi

      # --- 2. หาชื่อ Test Classes (ปรับให้ใช้เว้นวรรคแทนคอมมา) ---
      - name: Identify Unique Tests
        id: tests
        run: |
          # ค้นหาไฟล์ .cls ที่เปลี่ยน แล้วเติม Test ต่อท้าย
          # ใช้ xargs echo เพื่อให้ชื่อคลาสคั่นด้วย "เว้นวรรค" (Space) แทนคอมมา
          TESTS=$(git diff --name-only ${{ github.event.before || 'HEAD~1' }} HEAD 2>/dev/null | grep '\.cls$' | \
            sed 's/.*\///;s/\.cls//' | sed 's/Test$//' | sed 's/$/Test/' | \
            sort -u | xargs echo)
          
          echo "test_classes=$TESTS" >> $GITHUB_ENV
          echo "Found Tests: $TESTS"

      # --- 3. Deploy แบบฉลาด ---
      - name: Deploy Selective Source
        run: |
          HAS_CHANGES=false
          if [ -f "delta/package/package.xml" ] && grep -q "<members>" delta/package/package.xml; then HAS_CHANGES=true; fi
          if [ -f "delta/destructiveChanges/destructiveChanges.xml" ] && grep -q "<members>" delta/destructiveChanges/destructiveChanges.xml; then HAS_CHANGES=true; fi

          if [ "$HAS_CHANGES" = "true" ]; then
            if [ -n "${{ env.test_classes }}" ]; then
              echo "Running with Specified Tests: ${{ env.test_classes }}"
              # ไม่ต้องใส่เครื่องหมายคำพูดครอบ ${{ env.test_classes }} เพื่อให้ CLI มองเห็นเป็นหลาย arguments
              sf project deploy start \
                --manifest delta/package/package.xml \
                --post-destructive-changes delta/destructiveChanges/destructiveChanges.xml \
                --test-level RunSpecifiedTests \
                --tests ${{ env.test_classes }} \
                --wait 30
            else
              echo "No Apex changes. Running with NoTestRun."
              sf project deploy start \
                --manifest delta/package/package.xml \
                --post-destructive-changes delta/destructiveChanges/destructiveChanges.xml \
                --test-level NoTestRun \
                --wait 30
            fi
          else
            echo "No Salesforce metadata changes detected. Skipping deploy."
          fi

      - name: Summary
        if: always()
        run: |
          echo "### Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Tests Run:** ${{ env.test_classes || 'None' }}" >> $GITHUB_STEP_SUMMARY
          [ -f delta/package/package.xml ] && echo "- **Delta Manifest Created**" >> $GITHUB_STEP_SUMMARY || echo "- **No Changes Detected**" >> $GITHUB_STEP_SUMMARY