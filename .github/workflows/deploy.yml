name: Salesforce CI-CD (Delta & Selective Deploy)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  validate-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ต้องใช้ 0 เพื่อให้ SGD คำนวณความต่างได้

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Salesforce CLI & SGD Plugin
        run: |
          npm install @salesforce/cli --global
          echo y | sf plugins install sfdx-git-delta

      - name: Authenticate to Salesforce
        env:
          SFDX_AUTH_URL: ${{ secrets.SFDX_AUTH_URL }}
        run: |
          echo "$SFDX_AUTH_URL" > sfdx_auth.txt
          sf org login sfdx-url --sfdx-url-file sfdx_auth.txt --set-default

      # --- 1. สร้าง Delta Package (เพิ่ม -p เพื่อกัน Error โฟลเดอร์ซ้ำ) ---
      - name: Create Delta Manifest
        run: |
          mkdir -p delta
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            sf sgd source delta --to HEAD --from origin/${{ github.base_ref }} --output delta/ --generate-delta
          else
            # รองรับกรณี Push ครั้งแรกที่ไม่มี HEAD~1
            FROM_SHA=$(git rev-parse HEAD~1 2>/dev/null || git rev-list --max-parents=0 HEAD)
            sf sgd source delta --to HEAD --from $FROM_SHA --output delta/ --generate-delta
          fi

      # --- 2. หาชื่อ Test Classes ---
      - name: Identify Unique Tests
        id: tests
        run: |
          # ค้นหาไฟล์ .cls ที่มีการเปลี่ยนแปลง
          TESTS=$(git diff --name-only ${{ github.event.before || 'HEAD~1' }} HEAD 2>/dev/null | grep '\.cls$' | \
            sed 's/.*\///;s/\.cls//' | sed 's/Test$//' | sed 's/$/Test/' | \
            sort -u | xargs echo | sed 's/ /,/g')
          
          echo "test_classes=$TESTS" >> $GITHUB_ENV
          echo "Found Tests: $TESTS"

      # --- 3. Deploy แบบฉลาด (ตรวจเช็คก่อนว่ามีของให้ลงไหม) ---
      - name: Deploy Selective Source
        run: |
          # ตรวจสอบว่าใน package.xml หรือ destructiveChanges.xml มีการระบุ Metadata จริงๆ หรือไม่
          # โดยการเช็คว่ามีแท็ก <members> อยู่ในไฟล์ไหม
          HAS_CHANGES=false
          if [ -f "delta/package/package.xml" ] && grep -q "<members>" delta/package/package.xml; then HAS_CHANGES=true; fi
          if [ -f "delta/destructiveChanges/destructiveChanges.xml" ] && grep -q "<members>" delta/destructiveChanges/destructiveChanges.xml; then HAS_CHANGES=true; fi

          if [ "$HAS_CHANGES" = "true" ]; then
            echo "Detected metadata changes. Starting deployment..."
            
            DEPLOY_CMD="sf project deploy start \
              --manifest delta/package/package.xml \
              --post-destructive-changes delta/destructiveChanges/destructiveChanges.xml \
              --wait 30"

            if [ -n "${{ env.test_classes }}" ]; then
              echo "Running with Specified Tests: ${{ env.test_classes }}"
              $DEPLOY_CMD --test-level RunSpecifiedTests --tests ${{ env.test_classes }}
            else
              echo "No Apex changes. Running with NoTestRun."
              $DEPLOY_CMD --test-level NoTestRun
            fi
          else
            echo "No Salesforce metadata changes detected (Only non-Salesforce files changed). Skipping deploy to avoid Error."
          fi

      - name: Summary
        if: always()
        run: |
          echo "### Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Tests Run:** ${{ env.test_classes || 'None' }}" >> $GITHUB_STEP_SUMMARY
          [ -f delta/package/package.xml ] && echo "- **Delta Manifest Created**" >> $GITHUB_STEP_SUMMARY || echo "- **No Changes Detected**" >> $GITHUB_STEP_SUMMARY