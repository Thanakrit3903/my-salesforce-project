name: Salesforce CI-CD (Smart Selective Deploy)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  validate-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Salesforce CLI
        run: npm install @salesforce/cli --global

      - name: Authenticate to Salesforce
        env:
          SFDX_AUTH_URL: ${{ secrets.SFDX_AUTH_URL }}
        run: |
          echo "$SFDX_AUTH_URL" > sfdx_auth.txt
          sf org login sfdx-url --sfdx-url-file sfdx_auth.txt --set-default

      # --- ขั้นตอนค้นหาไฟล์ที่เปลี่ยน และ คลาสเทสที่ต้องรัน ---
      - name: Identify Changed Files and Tests
        id: changed-assets
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            DIFF_BASE="${{ github.event.pull_request.base.sha }}"
          else
            DIFF_BASE=$(git rev-parse HEAD~1)
          fi
          
          # 1. หาไฟล์ที่เปลี่ยน (เพื่อ Deploy)
          CHANGED_FILES=$(git diff --name-only "$DIFF_BASE" HEAD | grep '^force-app/' | xargs echo)
          echo "changed_files=$CHANGED_FILES" >> $GITHUB_ENV
          
          # 2. หาชื่อ Class ที่เปลี่ยนเพื่อระบุ Test (เอาเฉพาะ .cls และตัดคำว่า Test ออกเพื่อหาคู่ของมัน)
          # เช่นถ้าแก้ AccountService.cls จะรัน AccountServiceTest
          TEST_CLASSES=$(git diff --name-only "$DIFF_BASE" HEAD | grep '\.cls$' | grep -v 'Test\.cls' | sed 's/.*\///;s/\.cls//' | sed 's/$/Test/' | xargs | sed 's/ /,/g')
          
          # 3. ถ้าแก้ไฟล์ Test ตรงๆ ก็ให้รันตัวมันเองด้วย
          DIRECT_TESTS=$(git diff --name-only "$DIFF_BASE" HEAD | grep 'Test\.cls' | sed 's/.*\///;s/\.cls//' | xargs | sed 's/ /,/g')
          
          # รวมรายชื่อ Test ทั้งหมด
          ALL_TESTS=$(echo "$TEST_CLASSES,$DIRECT_TESTS" | sed 's/^,//;s/,$//;s/,,/,/g')
          
          echo "Changed files to deploy: $CHANGED_FILES"
          echo "Tests to run: $ALL_TESTS"
          echo "test_classes=$ALL_TESTS" >> $GITHUB_ENV

      # --- รัน Test เฉพาะตัวที่เกี่ยวข้อง และเช็ค Coverage 75% ---
      - name: Run Selective Tests
        if: env.test_classes != ''
        run: |
          # รันเทสแบบระบุชื่อคลาส และต้องการผลลัพธ์เป็น JSON เพื่อเช็ค Coverage
          sf apex run test \
            --tests ${{ env.test_classes }} \
            --result-format human \
            --code-coverage \
            --wait 30 \
            --detailed-coverage
          
          # หมายเหตุ: Salesforce จะสั่ง Fail อัตโนมัติถ้า Test ไม่ผ่าน 
          # ส่วนเรื่อง 75% ระบบ Deploy จะเช็คต่อในขั้นตอนถัดไป

      # --- Deploy (หรือ Validate) เฉพาะไฟล์ที่แก้ ---
      - name: Deploy Selective Source
        if: env.changed_files != ''
        run: |
          # ใช้ --test-level RunSpecifiedTests เพื่อประหยัดเวลา
          # และ Salesforce จะบังคับให้ผ่าน 75% ของไฟล์ที่ส่งไปโดยอัตโนมัติ
          sf project deploy start \
            --source-dir ${{ env.changed_files }} \
            --test-level RunSpecifiedTests \
            --tests ${{ env.test_classes }} \
            --wait 30