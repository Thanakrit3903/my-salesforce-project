name: Salesforce CI-CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  validate-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout source code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Salesforce CLI
        run: npm install @salesforce/cli --global

      - name: Debug sf binary and plugins
        run: |
          echo "=== sf version & path ==="
          sf --version || true
          command -v sf || true
          echo "=== sf plugins (before) ==="
          sf plugins || true

      - name: Install sfdx-git-delta plugin for sf (primary)
        run: |
          set -euo pipefail
          # ติดตั้ง plugin ให้ sf (ไม่ให้ล้ม workflow ถ้าติดตั้งแล้ว)
          sf plugins install sfdx-git-delta@latest || true
          echo "=== sf plugins (after install) ==="
          sf plugins || true

      - name: Authenticate to Salesforce
        env:
          SFDX_AUTH_URL: ${{ secrets.SFDX_AUTH_URL }}
        run: |
          set -euo pipefail
          if [ -z "${SFDX_AUTH_URL:-}" ]; then
            echo "SFDX_AUTH_URL secret is not set. Aborting."
            exit 1
          fi
          echo "$SFDX_AUTH_URL" > sfdx_auth.txt
          chmod 600 sfdx_auth.txt
          sf org login sfdx-url --sfdx-url-file sfdx_auth.txt --set-default

      - name: Run Apex All Tests with Coverage Check (PR and push)
        run: |
          set -euo pipefail
          sf apex run test \
            --test-level RunLocalTests \
            --result-format human \
            --code-coverage \
            --wait 30

      - name: Prepare output folder
        run: mkdir -p output

      - name: Generate Delta Package (sf sgd -> npx sfdx-git-delta -> local install)
        env:
          GITHUB_EVENT_NAME: ${{ github.event_name }}
        run: |
          set -euo pipefail

          # determine base ref
          if [ "${GITHUB_EVENT_NAME}" = "pull_request" ]; then
            BASE_REF="${{ github.event.pull_request.base.sha }}"
            if [ -z "${BASE_REF}" ]; then
              echo "PR base sha is empty. Aborting."
              exit 1
            fi
          else
            BASE_REF="$(git rev-parse --verify HEAD~1)"
          fi

          echo "Generating delta from $BASE_REF to HEAD into output/"

          # 1) Primary: use sf sgd if available
          if sf sgd source delta --help > /dev/null 2>&1; then
            echo "Using sf sgd (plugin) to generate delta..."
            sf sgd source delta --from "$BASE_REF" --to HEAD --output-dir output --generate-delta
            exit 0
          fi

          # 2) Fallback: try npx sfdx-git-delta (call package by name)
          echo "sf sgd not available. Trying npx sfdx-git-delta..."
          if npx --yes sfdx-git-delta --help > /dev/null 2>&1; then
            echo "Running npx sfdx-git-delta to generate delta..."
            npx --yes sfdx-git-delta --from "$BASE_REF" --to HEAD --output output --generate-delta
            exit 0
          else
            echo "npx sfdx-git-delta not usable or failed. Will try local install."
          fi

          # 3) Fallback: install locally and run binary from node_modules/.bin
          echo "Installing sfdx-git-delta locally..."
          npm install sfdx-git-delta@latest --no-save

          # ensure local bin is in PATH
          export PATH="$PWD/node_modules/.bin:$PATH"

          echo "Listing node_modules/.bin:"
          ls -la ./node_modules/.bin || true

          # try both possible binary names
          if command -v sgd > /dev/null 2>&1; then
            echo "Found sgd in PATH, running sgd..."
            sgd --from "$BASE_REF" --to HEAD --output output --generate-delta
            exit 0
          fi

          if command -v sfdx-git-delta > /dev/null 2>&1; then
            echo "Found sfdx-git-delta in PATH, running sfdx-git-delta..."
            sfdx-git-delta --from "$BASE_REF" --to HEAD --output output --generate-delta
            exit 0
          fi

          # If still not found, print diagnostics and fail
          echo "ERROR: sgd / sfdx-git-delta binary not found after local install. Diagnostics:"
          echo "Node version: $(node --version || true)"
          echo "NPM version: $(npm --version || true)"
          echo "ls node_modules/.bin:"
          ls -la ./node_modules/.bin || true
          echo "npm list sfdx-git-delta (local):"
          npm list sfdx-git-delta || true
          echo "sf version and plugins:"
          sf --version || true
          sf plugins || true
          exit 1

      - name: Inspect delta output
        run: |
          echo "=== output contents ==="
          ls -la output || true
          echo "=== recursive listing ==="
          ls -R output || true

      - name: Upload delta output artifact (always)
        uses: actions/upload-artifact@v4
        with:
          name: delta-output
          path: output

      - name: Upload npm logs (if any)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: npm-logs
          path: /home/runner/.npm/_logs/*.log

      - name: Debug info (sf version & plugins) on failure
        if: failure()
        run: |
          echo "=== sf version ==="
          sf --version || true
          echo "=== sf plugins ==="
          sf plugins || true
          echo "=== node & npm ==="
          node --version || true
          npm --version || true

      - name: Deploy Delta to Salesforce
        if: github.event_name == 'push' && success()
        run: |
          set -euo pipefail
          if [ -z "$(ls -A output 2>/dev/null || true)" ]; then
            echo "No delta content found in output. Aborting deploy."
            exit 1
          fi

          echo "Deploying from output/ to Salesforce..."
          sf project deploy start \
            --source-dir output \
            --test-level RunLocalTests \
            --wait 30
