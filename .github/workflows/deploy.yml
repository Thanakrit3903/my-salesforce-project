name: Salesforce CI-CD (Delta & Selective Deploy)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  validate-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ต้องใช้ 0 เพื่อให้ SGD คำนวณความต่างได้

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Salesforce CLI & SGD Plugin
        run: |
          npm install @salesforce/cli --global
          echo y | sf plugins install sfdx-git-delta

      - name: Authenticate to Salesforce
        env:
          SFDX_AUTH_URL: ${{ secrets.SFDX_AUTH_URL }}
        run: |
          echo "$SFDX_AUTH_URL" > sfdx_auth.txt
          sf org login sfdx-url --sfdx-url-file sfdx_auth.txt --set-default

      # --- ขั้นตอนสร้าง Delta Package (สร้างส่วนต่าง + ตัวลบ) ---
      - name: Create Delta Manifest
        run: |
          mkdir delta
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # เทียบ PR กับกิ่งปลายทาง
            sf sgd source delta --to HEAD --from origin/${{ github.base_ref }} --output delta/ --generate-delta
          else
            # เทียบ Push กับ Commit ก่อนหน้า (รองรับเคส Push ครั้งแรก)
            FROM_SHA=$(git rev-parse HEAD~1 2>/dev/null || git rev-list --max-parents=0 HEAD)
            sf sgd source delta --to HEAD --from $FROM_SHA --output delta/ --generate-delta
          fi

      # --- ขั้นตอนหาชื่อ Test Classes (ปรับให้ Clean ขึ้น) ---
      - name: Identify Unique Tests
        id: tests
        run: |
          # หาไฟล์ .cls ที่เปลี่ยน แล้วเติม Test ต่อท้าย (ตัดตัวซ้ำ)
          # และลบคำว่า Test ที่ติดมาออกก่อนเพื่อให้แน่ใจว่าชื่อไม่ซ้ำซ้อน
          TESTS=$(git diff --name-only ${{ github.event.before || 'HEAD~1' }} HEAD | grep '\.cls$' | \
            sed 's/.*\///;s/\.cls//' | sed 's/Test$//' | sed 's/$/Test/' | \
            sort -u | xargs echo | sed 's/ /,/g')
          
          echo "test_classes=$TESTS" >> $GITHUB_ENV
          echo "Found Tests: $TESTS"

      # --- ขั้นตอน Deploy (ใช้ Manifest จะปลอดภัยกว่า) ---
      - name: Deploy Selective Source
        # รันเฉพาะถ้ามีไฟล์เปลี่ยนใน package.xml (สร้าง/แก้) หรือมีใน destructiveChanges.xml (ลบ)
        if: hashFiles('delta/package/package.xml') != '' || hashFiles('delta/destructiveChanges/destructiveChanges.xml') != ''
        run: |
          DEPLOY_CMD="sf project deploy start \
            --manifest delta/package/package.xml \
            --post-destructive-changes delta/destructiveChanges/destructiveChanges.xml \
            --wait 30"

          if [ -n "${{ env.test_classes }}" ]; then
            echo "Deploying with Specified Tests..."
            $DEPLOY_CMD --test-level RunSpecifiedTests --tests ${{ env.test_classes }}
          else
            echo "Deploying with No Test Run (No Apex changes)..."
            $DEPLOY_CMD --test-level NoTestRun
          fi

      - name: Summary
        if: always()
        run: |
          echo "### Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Tests Run:** ${{ env.test_classes || 'None' }}" >> $GITHUB_STEP_SUMMARY
          [ -f delta/package/package.xml ] && echo "- **Delta Manifest Created**" >> $GITHUB_STEP_SUMMARY || echo "- **No Changes Detected**" >> $GITHUB_STEP_SUMMARY