name: Salesforce CI-CD

on:
  push:
    branches: [ main ] # Deploy เมื่อ push ลง main
  pull_request:
    branches: [ main ] # รัน Test เมื่อมีคนเปิด PR เพื่อตรวจสอบก่อนรวมเข้า main

jobs:
  validate-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. ดึง Code จาก GitHub
      - name: Checkout source code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # 2. ติดตั้ง Salesforce CLI
      - name: Install Salesforce CLI
        run: npm install @salesforce/cli --global

      # 3. Login เข้า Salesforce โดยใช้กุญแจที่เราเก็บไว้ใน Secrets
      - name: Authenticate to Salesforce
        run: |
          echo "${{ secrets.SFDX_AUTH_URL }}" > sfdx_auth.txt
          chmod 600 sfdx_auth.txt
          sf org login sfdx-url --sfdx-url-file sfdx_auth.txt --set-default

      # 4. รัน Test และ Validate (ตรวจเช็คเฉยๆ ไม่ Deploy จริง)
      - name: Run Apex All Tests with Coverage Check
        run: |
          sf apex run test \
            --test-level RunLocalTests \
            --result-format human \
            --code-coverage \
            --wait 30

      # 5. Deploy จริง (เมื่อมีการ Push/Merge เข้า main เท่านั้น)
      - name: Deploy to Salesforce
        if: github.event_name == 'push' && success()
        run: |
          sf project deploy start \
            --source-dir force-app \
            --test-level RunLocalTests \
            --wait 30