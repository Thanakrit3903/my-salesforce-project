name: Salesforce CI-CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  validate-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4 # อัปเกรดเป็น v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Salesforce CLI
        run: npm install @salesforce/cli --global

      - name: Authenticate to Salesforce
        env:
          SFDX_AUTH_URL: ${{ secrets.SFDX_AUTH_URL }}
        run: |
          echo "$SFDX_AUTH_URL" > sfdx_auth.txt
          sf org login sfdx-url --sfdx-url-file sfdx_auth.txt --set-default

      - name: Run Apex Tests
        run: |
          sf apex run test \
            --test-level RunLocalTests \
            --result-format human \
            --code-coverage \
            --wait 30

      - name: Generate Delta Package
        run: |
          mkdir -p output
          
          # หาจุดตัดของ Commit
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_REF="${{ github.event.pull_request.base.sha }}"
          else
            BASE_REF=$(git rev-parse HEAD~1)
          fi
          
          echo "Comparing $BASE_REF to HEAD"

          # 1. ติดตั้ง plugin แบบระบุชื่อให้ชัดเจนลงในโปรเจกต์ชั่วคราว
          npm install sfdx-git-delta@latest

          # 2. เรียกใช้โดยระบุ Path ตรงๆ ไปที่ node_modules (ตัดปัญหา npx หาไม่เจอ)
          ./node_modules/.bin/sgd --from "$BASE_REF" --to HEAD --output output --generate-delta
          
      - name: Inspect Delta Results
        run: |
          echo "=== Delta package.xml ==="
          cat output/package/package.xml || echo "No changes found"

      - name: Deploy to Salesforce
        if: github.event_name == 'push' && success()
        run: |
          # ตรวจสอบว่ามีไฟล์ให้ Deploy หรือไม่
          if [ -f "output/package/package.xml" ]; then
            sf project deploy start \
              --manifest output/package/package.xml \
              --test-level RunLocalTests \
              --wait 30
          else
            echo "Nothing to deploy."
          fi

      - name: Upload Delta Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: delta-package
          path: output/